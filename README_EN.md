# PolyCyber Infrastructure

The purpose of this repository is to gather all the resources used to deploy PolyCyber's CTFd infrastructures (PolyPwn, as well as internal CTFd for PolyCyber) in order to share a functional and simplified method for deploying services.

## Available Scripts

### 1. CTFd Installation Script (`setup.sh`)

Bash script that automates the installation and configuration of a CTFd server using the [Zync](https://github.com/28Pollux28/zinc) plugin and its dedicated instancer[Galvanize](https://github.com/28Pollux28/galvanize).

### 2. Challenge Management Tool (`challenges_management.sh`)

Bash script for building, ingesting, and synchronizing CTF challenges with support for Docker containers and Docker compose.

## Prerequisites

### For the CTFd installation script

- **Operating System**: Tested and verified on:
  - Ubuntu Server 24
  - Ubuntu Server 25
  - Debian 12
- **Privileges**: The script must be executed as root (automatically uses sudo if necessary)

### For the challenge management tool

- **Docker**: Installed and functional
- **curl, jq, yq**: For API calls and YAML/JSON processing (automatically verified)
- **Challenge repository**: Folder structure with `challenge.yml` files

## CTFd Server Installation

1. **Clone this repository**:
   ```bash
   git clone https://github.com/polycyber/infra
   cd infra
   chmod +x setup.sh challenges_management.sh
   ```

2. **Run the installation script and follow the instructions**:
   ```bash
   ./setup.sh --ctfd-url <your-domain.com>
   ```
3. **Go to the configured server URL**
   - Configure the CTF event
   - Navigate to the admin configuration panel: `Admin Panel` --> `Plugins` --> `Zync Config`
   - Enter your Galvanize instancer's URL and JWT secret generated by the setup

## Usage

### Installation Script Options

| Option | Description | Required |
|--------|-------------|-------------|
| `--ctfd-url URL/IP` | URL/domain of your CTFd server | ✅ Yes |
| `--working-folder DIR` | Working directory (default: `/home/$USER`) | ❌ No |
| `--theme DIR/URL` | Enables the use of a personalised theme | ❌ No |
| `--backup-schedule TYPE` | Database backup frequency (`daily` (default), `hourly`, `10min`) | ❌ No |
| `--no-https` | Deployment without HTTPS | ❌ No |
| `--help` | Display help | ❌ No |

#### Installation Examples

```bash
# Basic installation with domain
./setup.sh --ctfd-url example.com

# Basic installation with domain - automatically uses the --no-https option
./setup.sh --ctfd-url 192.168.12.34

# Installation with custom directory
./setup.sh --ctfd-url example.com --working-folder /opt/ctfd

# Installation with custom theme
./setup.sh --ctfd-url example.com --theme  /home/user/my-custom-theme

# Installation with custom theme downloading a theme directly from github 
./setup.sh --ctfd-url example.com --theme https://github.com/user/theme.git

# Hourly backup
./setup.sh --ctfd-url example.com --backup-schedule hourly

# Backup every 10 minutes
./setup.sh --ctfd-url example.com --backup-schedule 10min

# Display help
./setup.sh --help
```

#### Custom theme configuration

If you use the `--theme` option, the script will automatically mount the custom theme folder in the `docker-compose.yml`. 

### Challenge Management Tool

#### Available Actions

| Action | Description |
|--------|-------------|
| `all` | Build + ingest (default) |
| `build` | Build Docker images only |
| `ingest` | Ingest challenges into CTFd |
| `sync` | Synchronize existing challenges |
| `status` | Display status and statistics |
| `cleanup` | Clean up Docker images |

#### Main Options

| Option | Description | Required |
|--------|-------------|-------------|
| `--ctf-repo REPO` | Name of the challenge repository present in the working directory | ✅ Yes |
| `--action ACTION` | Action to perform (all (default), build, ingest, sync, status, cleanup) | ❌ No |
| `--working-folder DIR` | Working directory (default: `/home/$USER`) | ❌ No |
| `--config FILE` | Load configuration from a file | ❌ No |

#### Filtering Options

| Option | Description |
|--------|-------------|
| `--categories LIST` | List of categories to process (comma-separated) |
| `--challenges LIST` | List of specific challenges to process (comma-separated) |

#### Behavior Options

| Option | Description |
|--------|-------------|
| `--dry-run` | Simulation mode (shows actions without executing them) |
| `--force` | Force operations (rebuild, overwrite) |
| `--parallel-builds N` | Number of parallel builds (default: 4) |

#### Debug Options

| Option | Description |
|--------|-------------|
| `--debug` | Enable debug output |
| `--skip-docker-check` | Skip Docker daemon check |
| `--help` | Display help |
| `--version` | Display version information |

#### Challenge Management Examples

```bash
# Full configuration (build + ingest)
./challenges_management.sh --ctf-repo PolyPwnCTF-2025-challenges

# Build only for certain categories
./challenges_management.sh --action build --ctf-repo PolyPwnCTF-2025-challenges --categories "web,crypto"

# Synchronization with forced update
./challenges_management.sh --action sync --ctf-repo PolyPwnCTF-2025-challenges --force

# Simulation mode to see planned actions
./challenges_management.sh --ctf-repo PolyPwnCTF-2025-challenges --dry-run

# Processing specific challenges
./challenges_management.sh --action build --ctf-repo PolyPwnCTF-2025-challenges --challenges "web-challenge-1,crypto-rsa"

# Parallel build with 8 threads
./challenges_management.sh --action build --ctf-repo PolyPwnCTF-2025-challenges --parallel-builds 8

# Display status
./challenges_management.sh --action status --ctf-repo PolyPwnCTF-2025-challenges

# Clean up Docker images
./challenges_management.sh --action cleanup --ctf-repo PolyPwnCTF-2025-challenges
```

#### Configuration File

Create a `.env` file with `KEY=VALUE` pairs:

```bash
CTF_REPO=PolyPwnCTF-2025-challenges
WORKING_DIR=/opt/ctf
PARALLEL_BUILDS=8
FORCE=true
DEBUG=false
```

Usage:
```bash
./challenges_management.sh --config .env
```

## Script Functionality

### CTFd Installation Script

#### 1. System Update
- Update system packages
- Install dependencies

#### 2. Docker Installation
- Add official Docker repository
- Install Docker CE, Docker Compose, etc.
- Configure user groups

#### 3. Theme configuration (optionnal)
If the `--theme` flag is used:
- Mounts the `theme/custom/` folder in the CTFd container
- Enables the use of custom themes

### Challenge Management Tool

#### 1. Dependency Check
- Verify Docker and daemon availability
- Check for required system tools (curl, jq, yq)

#### 2. Challenge Discovery
- Analyze the challenge repository structure
- Identify Docker and static challenges

#### 3. Docker Image Building
- Sequential or parallel image building
- Support for `--force` mode for complete rebuild
- Error handling with detailed reports

#### 4. Challenge Ingestion
- Installation via the CTFd API into the CTFd instance

#### 5. Synchronization
- Update existing challenges
- Option to backup before synchronization
- Support for `--force` mode for overwriting

#### 6. Cleanup
- Remove Docker images associated with challenges
- Dry-run mode available

## Challenge Structure

### Expected Challenge Repository

```
repo-challenges/
├── challenges/                    # (optional, detected automatically)
│   ├── web/
│   │   ├── challenge-1/
│   │   │   ├── challenge.yml      # Challenge configuration
│   │   │   ├── Dockerfile         # Docker image (for type: docker)
│   │   │   ├── src/               # Source code
│   │   │   └── files/             # Challenge files
│   │   └── challenge-2/
│   ├── crypto/
│   └── pwn/
```

> [!WARNING]
> The challenge ingestion script works in alphabetical order of categories and challenges. If a challenge has prerequisites, it is necessary to ingest the prerequisites beforehand.

### Format of the `challenge.yml` File

```yaml
name: "MyChallenge"
author: Challenge_Author
category: AI

description: |-
  ## Description (French)

  Petite description en français

  ## Description (English)

  Short description in English

flags:
  - polycyber{flag_to_find}

tags:
  - AI
  - A:Challenge_Author

requirements:
  - "Rules"

# If files needed
files:
  - "files/hello_world.txt"

# If hints needed, choose the cost
hints:
  - Interesting hint

value: 500
type: docker                          # or type: dynamic
extra:
  docker_image: "mychallenge:latest"  # required for type: docker
  dynamic: True                       # required for type: docker
  initial: 500
  decay: 10
  minimum: 50
```

## Generated Configuration

### Generated Secrets

The script automatically generates:
- **CTFd secret key** (32 characters)
- **Database password** (16 characters)
- **Database root password** (16 characters)

These scripts are developed by the PolyCyber team for the automated installation and management of CTFd servers.